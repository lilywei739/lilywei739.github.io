<!DOCTYPE html>
<html lang="zh">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
        <meta http-equiv="Cache-Control" content="no-siteapp" />
        <meta name="robots" content="index,follow"/>
        <meta name="renderer" content="webkit" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui" />
        <meta name="keywords" content="nodejs V6 不能用 import/export 解决方法">
        <meta name="screen-orientation" content="portrait" />
        <meta name="full-screen" content="yes" />
        <meta name="browsermode" content="application" />
        <meta name="x5-orientation" content="portrait" />
        <meta name="x5-fullscreen" content="true" />
        <meta name="x5-page-mode" content="app" />
        <title>nodejs V6 不能用 import/export 解决方法</title>
        <link rel="shortcut icon" type="image/ico" href="/favicon.ico"/>
        <link rel="stylesheet" href="/css/common/github-gist.min.css">
        <link rel="stylesheet" href="/css/style.css">
        <!--[if lt IE 9]>
        <script src="/js/common/html5.js"></script>
        <![endif]-->
    </head>
    <body>
        <!-- HEADER -->
        <div id="header_wrap" class="outer">
            <header class="inner">
                <h1 id="project_title"><a href="/">Weili - GitHub.io</a></h1>
                <h2 id="project_tagline">View on GitHub</h2>
            </header>
        </div>
            
        <div id="content-wrapper">
            <div class="main clearfix">
                <aside id="sidebar">
                    <ul class="side-nav">
                    </ul>
                </aside>

                <section id="main-cont">
                    <h1 id="nodejs-v6--importexport-">nodejs V6 不能用 import/export 解决方法</h1>

<p>nodejs 发布已有多时，版本 log 重点说明从此 nodejs 开始<strong>原生</strong>支持 <code class="highlighter-rouge">ES6</code>，这让许多开发者都 happy 了一下。</p>

<p>笔者立刻将原来的一个小 server 框架改成 ES6 语法，但是:</p>

<p><img src="/img/node_module/1.png" alt="不支持 import" /></p>

<p><strong>WTF!</strong>~~~说好的全部原生支持呢？<code class="highlighter-rouge">import</code> / <code class="highlighter-rouge">export</code>各种报错，加了<code class="highlighter-rouge">--es_staging</code>，也不行，人与人之前的信任呢？</p>

<p>回头再查查版本 log ，Modules 那一章还是 commonjs 的引用方法，网上其它人也说这个问题，那就是妥妥的不支持了。</p>

<p>测试文件如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>
    <span class="s1">'use strict'</span><span class="p">;</span>
    <span class="kr">class</span> <span class="nx">Main</span> <span class="p">{</span>
        <span class="nx">constructor</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="s1">'this is parent msg'</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">say</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">);</span>
            <span class="p">},</span> <span class="mi">500</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kr">export</span> <span class="k">default</span> <span class="nx">Main</span><span class="p">;</span>
</code></pre>
</div>

<h2 id="section">简单暴力(没)有成效的解决方法</h2>

<p>“不支持 ES6 就用 babel 转换呗~” 大多数人都是这样想的。将完全体的 ES6 通过 babel 降级转换~~~然后就 OK 了。node 运行各种顺利。</p>

<p>标签 es2015 转换后：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>    <span class="s1">'use strict'</span><span class="p">;</span>

    <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">exports</span><span class="p">,</span> <span class="s2">"__esModule"</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">value</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">});</span>

    <span class="kd">var</span> <span class="nx">_createClass</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="kd">function</span> <span class="nx">defineProperties</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">props</span><span class="p">)</span> <span class="p">{</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">props</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="kd">var</span> <span class="nx">descriptor</span> <span class="o">=</span> <span class="nx">props</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span> <span class="nx">descriptor</span><span class="p">.</span><span class="nx">enumerable</span> <span class="o">=</span> <span class="nx">descriptor</span><span class="p">.</span><span class="nx">enumerable</span> <span class="o">||</span> <span class="kc">false</span><span class="p">;</span> <span class="nx">descriptor</span><span class="p">.</span><span class="nx">configurable</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="k">if</span> <span class="p">(</span><span class="s2">"value"</span> <span class="k">in</span> <span class="nx">descriptor</span><span class="p">)</span> <span class="nx">descriptor</span><span class="p">.</span><span class="nx">writable</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">descriptor</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="nx">descriptor</span><span class="p">);</span> <span class="p">}</span> <span class="p">}</span> <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">Constructor</span><span class="p">,</span> <span class="nx">protoProps</span><span class="p">,</span> <span class="nx">staticProps</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">protoProps</span><span class="p">)</span> <span class="nx">defineProperties</span><span class="p">(</span><span class="nx">Constructor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="nx">protoProps</span><span class="p">);</span> <span class="k">if</span> <span class="p">(</span><span class="nx">staticProps</span><span class="p">)</span> <span class="nx">defineProperties</span><span class="p">(</span><span class="nx">Constructor</span><span class="p">,</span> <span class="nx">staticProps</span><span class="p">);</span> <span class="k">return</span> <span class="nx">Constructor</span><span class="p">;</span> <span class="p">};</span> <span class="p">}();</span>

    <span class="kd">function</span> <span class="nx">_classCallCheck</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">Constructor</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">instance</span> <span class="k">instanceof</span> <span class="nx">Constructor</span><span class="p">))</span> <span class="p">{</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s2">"Cannot call a class as a function"</span><span class="p">);</span> <span class="p">}</span> <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">Main</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">function</span> <span class="nx">Main</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">_classCallCheck</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">Main</span><span class="p">);</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="s1">'this is parent msg'</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">_createClass</span><span class="p">(</span><span class="nx">Main</span><span class="p">,</span> <span class="p">[{</span>
            <span class="na">key</span><span class="p">:</span> <span class="s1">'say'</span><span class="p">,</span>
            <span class="na">value</span><span class="p">:</span> <span class="kd">function</span> <span class="nx">say</span><span class="p">()</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">_this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

                <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">_this</span><span class="p">.</span><span class="nx">parent</span><span class="p">);</span>
                <span class="p">},</span> <span class="mi">500</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}]);</span>

        <span class="k">return</span> <span class="nx">Main</span><span class="p">;</span>
    <span class="p">}();</span>

    <span class="nx">exports</span><span class="p">.</span><span class="k">default</span> <span class="o">=</span> <span class="nx">Main</span><span class="p">;</span>
    <span class="c1">//# sourceMappingURL=main.js.map</span>
</code></pre>
</div>

<p>……</p>

<p>我差点也就中了。</p>

<p>看着 node V6 对其它各种 es6 特性都支持的很好，真不想经转换后一下回到解放前。</p>

<blockquote>
  <p><strong>注：</strong>
其实上面一句并不是真正原因啦，node 的原生支持并不是简单暴力的内置了一个 babel，是在整个内核运行机制上进行改进，尽可能符合 es6 的语言思想。
在执行流程、内存管理上都有优化。网上有不少原生 es6 运行性能的对比，有兴趣可以去看一下。</p>
</blockquote>

<p>经笔者测试，以最新的 6.4 为例，好像只有 <code class="highlighter-rouge">import</code> / <code class="highlighter-rouge">export</code> 不能支持，因此，笔者试着找一下只对此进行降级转换的方法。</p>

<h2 id="babel-">针对性的 babel 降级转换</h2>

<p>通过查看 <code class="highlighter-rouge">babel</code> 的插件列表 <a href="http://babeljs.io/docs/plugins/">http://babeljs.io/docs/plugins/</a>;</p>

<p><img src="/img/node_module/2.png" alt="babel 插件" />;</p>

<p>其中在 <code class="highlighter-rouge">Modules</code> 有一个 <code class="highlighter-rouge">es2015_modules_commonjs</code>，应该就是将 ES6 Modules 转换成 nodejs 通用的 commonjs 形式的。</p>

<p>立刻试用，<code class="highlighter-rouge">.babelrc</code> 文件如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="w">    </span><span class="p">{</span><span class="w">
        </span><span class="nt">"plugins"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="s2">"transform-es2015-modules-commonjs"</span><span class="w">
        </span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<p>如此经过转换后的文件：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>    <span class="s1">'use strict'</span><span class="p">;</span>

    <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">exports</span><span class="p">,</span> <span class="s2">"__esModule"</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">value</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">});</span>
    <span class="kr">class</span> <span class="nx">Main</span> <span class="p">{</span>
        <span class="nx">constructor</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="s1">'this is parent msg'</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">say</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">);</span>
            <span class="p">},</span> <span class="mi">500</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">exports</span><span class="p">.</span><span class="k">default</span> <span class="o">=</span> <span class="nx">Main</span><span class="p">;</span>
    <span class="c1">//# sourceMappingURL=main.js.map</span>

</code></pre>
</div>

<p>执行通过 perfect!!! 要得就是这个效果。而且因为转换程度不深，速度也差不多减少了 2/3。</p>

<h2 id="section-1">总结</h2>

<p>如上只是一个经历，相信随着 nodejs 的不断发展，完美支持 es6 也是迟早的事。但新语法、新事物肯定也会随之出现，我们需要的是一个“增量式”的转换，希望对以后处理此类问题有所启发。</p>

                    <!-- 多说评论框 start -->
                    <div id="ds_ele" class="ds-thread" data-thread-key="" data-title="nodejs V6 不能用 import/export 解决方法" data-url="http://yj1438.github.io/2016/06/06/node_modules.html"></div>
                    <!-- 多说评论框 end -->
                    <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
                    <script type="text/javascript">
                        var url = window.location.pathname;
                        url = url.substr(1, url.length -6).replace(/\//gi, '_');
                        document.getElementById('ds_ele').dataset.threadKey = url;
                        var duoshuoQuery = {short_name:"yj1438"};
                        (function() {
                            var ds = document.createElement('script');
                            ds.type = 'text/javascript';ds.async = true;
                            ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
                            ds.charset = 'UTF-8';
                            (document.getElementsByTagName('head')[0] 
                            || document.getElementsByTagName('body')[0]).appendChild(ds);
                        })();
                    </script>
                    <!-- 多说公共JS代码 end -->
                </section>
            </div>
        </div>
            
        <!-- FOOTER  -->
        <div id="footer_wrap" class="outer">
            <footer class="inner">
                <p>© 2016  by Weili &nbsp;&nbsp;  |  &nbsp;&nbsp;托管在 - <a href="https://pages.github.com">GitHub</a></p>
            </footer>
        </div>
        <script src="/js/common/jquery-2.2.4.min.js"></script>
        <script src="/js/common/highlight.min.js"></script>
        <script src="/js/aside-nav.js"></script>
        <script>
            // baidu 统计
            var _hmt = _hmt || [];
            (function() {
                var hm = document.createElement("script");
                hm.src = "//hm.baidu.com/hm.js?146fe495fee020bf0e4dd701aa73965f";
                var s = document.getElementsByTagName("script")[0]; 
                s.parentNode.insertBefore(hm, s);
            })();
            // highlight
            hljs.initHighlightingOnLoad({useBR: true});
            $(document).ready(function() {
                $('pre code').each(function(i, block) {
                    hljs.highlightBlock(block);
                });

                // http2
                var img = new Image();
                img.src = 'https://www.h2statistics.ml/';
            });
        </script>
    </body>
</html>
